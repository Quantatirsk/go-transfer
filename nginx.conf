# 优化的 Nginx 配置 - 支持高速传输
# 解决 30MB/s 传输速度下的问题

server {
    listen 5000;
    server_name localhost;
    
    # 客户端最大上传文件大小 (100GB)
    client_max_body_size 100G;
    
    # 增大超时时间，防止大文件传输中断
    client_body_timeout 7200;      # 2小时
    client_header_timeout 7200;    
    keepalive_timeout 7200;
    send_timeout 7200;
    proxy_connect_timeout 7200;
    proxy_send_timeout 7200;
    proxy_read_timeout 7200;
    
    # 关键设置：完全禁用缓冲
    proxy_request_buffering off;   # 禁用请求缓冲
    proxy_buffering off;            # 禁用响应缓冲
    proxy_http_version 1.1;         # 使用 HTTP/1.1
    
    # 增大缓冲区大小（当缓冲无法完全禁用时）
    client_body_buffer_size 128M;   # 增大客户端请求缓冲
    proxy_buffer_size 64k;          # 代理缓冲区大小
    proxy_buffers 8 64k;            # 代理缓冲区数量和大小
    proxy_busy_buffers_size 128k;   # 忙碌时的缓冲区大小
    
    # TCP 优化
    tcp_nopush on;                  # 优化 TCP 包发送
    tcp_nodelay on;                 # 禁用 Nagle 算法，减少延迟
    
    # 保持连接设置
    keepalive_requests 1000;        # 单个连接最大请求数
    
    # /sender 路径代理到 go-transfer (C节点)
    location /sender/ {
        # 重写路径，移除 /sender 前缀
        rewrite ^/sender/(.*) /$1 break;
        
        # 代理到 go-transfer
        proxy_pass http://127.0.0.1:17002;
        
        # 保持原始请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 关键：使用 HTTP/1.1 和正确的连接管理
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # 确保流式传输
        proxy_buffering off;
        proxy_request_buffering off;
        
        # 不限制临时文件
        proxy_max_temp_file_size 0;
        
        # 增大读取超时
        proxy_read_timeout 7200s;
        proxy_send_timeout 7200s;
        
        # 忽略客户端断开（防止上传中断）
        proxy_ignore_client_abort off;
    }
    
    # 上传接口专门优化
    location /sender/upload {
        # 重写路径
        rewrite ^/sender/(.*) /$1 break;
        
        # 代理设置
        proxy_pass http://127.0.0.1:17002;
        
        # 请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 保持原始 Content-Type 和 Content-Length
        proxy_set_header Content-Type $content_type;
        proxy_pass_request_headers on;
        proxy_pass_request_body on;
        
        # HTTP/1.1 支持
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # 完全禁用缓冲 - 这是关键！
        proxy_buffering off;
        proxy_request_buffering off;
        
        # 不创建临时文件
        proxy_max_temp_file_size 0;
        client_body_temp_path /tmp;
        client_body_in_file_only off;
        client_body_in_single_buffer off;
        
        # 超长超时
        proxy_read_timeout 7200s;
        proxy_send_timeout 7200s;
        proxy_connect_timeout 7200s;
        
        # 防止连接断开
        proxy_ignore_client_abort off;
        proxy_next_upstream off;
    }
    
    # 其他端点保持简单配置
    location /sender/docs {
        rewrite ^/sender/(.*) /$1 break;
        proxy_pass http://127.0.0.1:17002;
        proxy_set_header Host $host;
    }
    
    location /sender/swagger.json {
        rewrite ^/sender/(.*) /$1 break;
        proxy_pass http://127.0.0.1:17002;
        proxy_set_header Host $host;
    }
    
    location /sender/status {
        rewrite ^/sender/(.*) /$1 break;
        proxy_pass http://127.0.0.1:17002;
        proxy_set_header Host $host;
    }
}